version: 3
projects:
- name: devops-ai-platform-infrastructure
  dir: terraform
  workspace: default
  terraform_version: v1.5.0
  autoplan:
    when_modified: ["*.tf", "../modules/**/*.tf"]
    enabled: true
  apply_requirements: [approved]
  workflow: terraform
  delete_source_branch_on_merge: true

workflows:
  terraform:
    plan:
      steps:
      - run: terraform init -upgrade
      - run: terraform plan -out=$PLANFILE
      - run: terraform show -json $PLANFILE > $PLANFILE.json
    apply:
      steps:
      - run: terraform init -upgrade
      - run: terraform apply $PLANFILE

repos:
- id: /.*/
  apply_requirements: [approved]
  allowed_overrides: [apply_requirements, workflow]
  allow_custom_workflows: true
